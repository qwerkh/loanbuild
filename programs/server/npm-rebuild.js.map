{"version":3,"names":["process","env","METEOR_SKIP_NPM_REBUILD","exit","fs","require","path","spawn","rebuildArgs","get","rebuilds","e","code","binDir","dirname","execPath","PATH","delimiter","npmCmd","platform","npmCmdPath","join","existsSync","rebuild","i","dir","stdio","cwd","__dirname","on"],"sources":["/tools/static-assets/server/npm-rebuild.js"],"sourcesContent":["// If a developer wants to go to the trouble of building on exactly the\n// same architecture as the production machine, then it should be possible\n// to skip running `npm rebuild`.\nif (process.env.METEOR_SKIP_NPM_REBUILD) {\n  process.exit(0);\n}\n\nvar fs = require(\"fs\");\nvar path = require(\"path\");\nvar spawn = require(\"child_process\").spawn;\nvar rebuildArgs = require(\"./npm-rebuild-args.js\").get();\n\ntry {\n  // This JSON file gets written in meteor/tools/isobuild/bundler.js.\n  var rebuilds = require(\"./npm-rebuilds.json\");\n} catch (e) {\n  if (e.code !== \"MODULE_NOT_FOUND\") {\n    throw e;\n  }\n\n  // If npm-rebuilds.json was not written, assume there is nothing that\n  // needs to be rebuilt.\n  process.exit(0);\n}\n\n// Make sure the npm finds this exact version of node in its $PATH.\nvar binDir = path.dirname(process.execPath);\nprocess.env.PATH = binDir + path.delimiter + process.env.PATH;\n\nvar npmCmd = \"npm\";\nif (process.platform === \"win32\") {\n  var npmCmdPath = path.join(binDir, \"npm.cmd\");\n  if (fs.existsSync(npmCmdPath)) {\n    npmCmd = npmCmdPath;\n  }\n}\n\nfunction rebuild(i) {\n  var dir = rebuilds && rebuilds[i];\n\n  if (! dir) {\n    // Print Node/V8/etc. versions for diagnostic purposes.\n    spawn(npmCmd, [\"version\", \"--json\"], {\n      stdio: \"inherit\"\n    });\n\n    return;\n  }\n\n  spawn(npmCmd, rebuildArgs, {\n    cwd: path.join(__dirname, dir),\n    stdio: \"inherit\"\n  }).on(\"exit\", function (code) {\n    if (code !== 0) {\n      process.exit(code);\n    } else {\n      rebuild(i + 1);\n    }\n  });\n}\n\nrebuild(0);\n"],"mappings":"AAAA;AACA;AACA;AACA,IAAIA,OAAO,CAACC,GAAR,CAAYC,uBAAhB,EAAyC;EACvCF,OAAO,CAACG,IAAR,CAAa,CAAb;AACD;;AAED,IAAIC,EAAE,GAAGC,OAAO,CAAC,IAAD,CAAhB;;AACA,IAAIC,IAAI,GAAGD,OAAO,CAAC,MAAD,CAAlB;;AACA,IAAIE,KAAK,GAAGF,OAAO,CAAC,eAAD,CAAP,CAAyBE,KAArC;;AACA,IAAIC,WAAW,GAAGH,OAAO,CAAC,uBAAD,CAAP,CAAiCI,GAAjC,EAAlB;;AAEA,IAAI;EACF;EACA,IAAIC,QAAQ,GAAGL,OAAO,CAAC,qBAAD,CAAtB;AACD,CAHD,CAGE,OAAOM,CAAP,EAAU;EACV,IAAIA,CAAC,CAACC,IAAF,KAAW,kBAAf,EAAmC;IACjC,MAAMD,CAAN;EACD,CAHS,CAKV;EACA;;;EACAX,OAAO,CAACG,IAAR,CAAa,CAAb;AACD,C,CAED;;;AACA,IAAIU,MAAM,GAAGP,IAAI,CAACQ,OAAL,CAAad,OAAO,CAACe,QAArB,CAAb;AACAf,OAAO,CAACC,GAAR,CAAYe,IAAZ,GAAmBH,MAAM,GAAGP,IAAI,CAACW,SAAd,GAA0BjB,OAAO,CAACC,GAAR,CAAYe,IAAzD;AAEA,IAAIE,MAAM,GAAG,KAAb;;AACA,IAAIlB,OAAO,CAACmB,QAAR,KAAqB,OAAzB,EAAkC;EAChC,IAAIC,UAAU,GAAGd,IAAI,CAACe,IAAL,CAAUR,MAAV,EAAkB,SAAlB,CAAjB;;EACA,IAAIT,EAAE,CAACkB,UAAH,CAAcF,UAAd,CAAJ,EAA+B;IAC7BF,MAAM,GAAGE,UAAT;EACD;AACF;;AAED,SAASG,OAAT,CAAiBC,CAAjB,EAAoB;EAClB,IAAIC,GAAG,GAAGf,QAAQ,IAAIA,QAAQ,CAACc,CAAD,CAA9B;;EAEA,IAAI,CAAEC,GAAN,EAAW;IACT;IACAlB,KAAK,CAACW,MAAD,EAAS,CAAC,SAAD,EAAY,QAAZ,CAAT,EAAgC;MACnCQ,KAAK,EAAE;IAD4B,CAAhC,CAAL;IAIA;EACD;;EAEDnB,KAAK,CAACW,MAAD,EAASV,WAAT,EAAsB;IACzBmB,GAAG,EAAErB,IAAI,CAACe,IAAL,CAAUO,SAAV,EAAqBH,GAArB,CADoB;IAEzBC,KAAK,EAAE;EAFkB,CAAtB,CAAL,CAGGG,EAHH,CAGM,MAHN,EAGc,UAAUjB,IAAV,EAAgB;IAC5B,IAAIA,IAAI,KAAK,CAAb,EAAgB;MACdZ,OAAO,CAACG,IAAR,CAAaS,IAAb;IACD,CAFD,MAEO;MACLW,OAAO,CAACC,CAAC,GAAG,CAAL,CAAP;IACD;EACF,CATD;AAUD;;AAEDD,OAAO,CAAC,CAAD,CAAP","file":"tools/static-assets/server/npm-rebuild.js.map"}