{"version":3,"names":["fs","require","path","createHash","Module","module","constructor","exports","enable","cachePath","createLoader","cacheEnabled","cacheEntries","Object","create","readdirSync","forEach","name","e","code","mkdirSync","Mp","prototype","resolve","id","_resolveFilename","moduleLoad","load","filename","result","apply","arguments","runSetters","resolved","Promise","dynamicImport","then","reifyVersion","version","reifyBabelParse","parse","reifyCompile","compile","compileContent","content","identical","generateLetDeclarations","ast","_compile","options","compiledWithReify","call","jsExt","_extensions","js","stat","statSync","baseKey","update","mtimeMs","ino","size","digest","identicalKey","key","readFileSync","join","origContent","writeFileLater","immediateTimer","pendingWrites","setImmediate","keys","targetPath","tempPath","writeFileSync","renameSync","err"],"sources":["/tools/static-assets/server/runtime.js"],"sourcesContent":["const fs = require('fs');\nconst path = require('path');\nconst { createHash } = require(\"crypto\");\nconst Module = module.constructor;\n\nmodule.exports = function enable ({ cachePath, createLoader = true } = {}) {\n  let cacheEnabled = !!cachePath;\n  let cacheEntries = Object.create(null);\n\n  if (cachePath) {\n    try {\n      fs.readdirSync(cachePath).forEach(name => {\n        cacheEntries[name] = true;\n      });\n    } catch (e) {\n      if (e.code === 'ENOENT') {\n        fs.mkdirSync(cachePath);\n      } else {\n        cacheEnabled = false;\n      }\n    }\n  }\n\n  const Mp = Module.prototype;\n\n  Mp.resolve = function (id) {\n    return Module._resolveFilename(id, this);\n  };\n\n  // Enable the module.{watch,export,...} runtime API needed by Reify.\n  require(\"@meteorjs/reify/lib/runtime\").enable(Mp);\n\n  const moduleLoad = Mp.load;\n  Mp.load = function (filename) {\n    const result = moduleLoad.apply(this, arguments);\n    if (typeof this.runSetters === \"function\") {\n      // Make sure we call module.runSetters (or module.runModuleSetters, a\n      // legacy synonym) whenever a module finishes loading.\n      this.runSetters();\n    }\n    return result;\n  };\n\n  const resolved = Promise.resolve();\n  Mp.dynamicImport = function (id) {\n    return resolved.then(() => require(id));\n  };\n\n  const reifyVersion = require(\"@meteorjs/reify/package.json\").version;\n  const reifyBabelParse = require(\"@meteorjs/reify/lib/parsers/babel\").parse;\n  const reifyCompile = require(\"@meteorjs/reify/lib/compiler\").compile;\n\n  function compileContent (content) {\n    let identical = true;\n\n    try {\n      const result = reifyCompile(content, {\n        parse: reifyBabelParse,\n        generateLetDeclarations: false,\n        ast: false,\n      });\n      if (!result.identical) {\n        identical = false;\n        content = result.code;\n      }\n    } finally {\n      return { content, identical };\n    }\n  }\n\n  const _compile = Mp._compile;\n  Mp._compile = function (content, filename, options) {\n    // When cache is enabled, the file has already been compiled\n    if (!options || !options.compiledWithReify) {\n      content = compileContent(content).content;\n    }\n\n    return _compile.call(this, content, filename);\n  };\n\n  if (cacheEnabled) {\n    const jsExt = Module._extensions.js;\n    Module._extensions['.js'] = function (module, filename) {\n      let stat = fs.statSync(filename);\n      let baseKey = createHash(\"sha1\")\n        .update(`${reifyVersion}\\0${filename}\\0${stat.mtimeMs}\\0${stat.ino}\\0${stat.size}\\0`)\n        .digest('hex');\n\n      // When files don't use import/export, there is no reason to store\n      // an identical copy of the file in the cache. Instead, it stores an empty\n      // file with a different suffix to indicate the original file should be used\n      let identicalKey = baseKey + '-identical.json';\n      let key = baseKey + '.json';\n\n      let content;\n      if (cacheEntries[key]) {\n        content = fs.readFileSync(path.join(cachePath, key), 'utf8');\n      } else if (cacheEntries[identicalKey]) {\n        content = fs.readFileSync(filename, 'utf8');\n      } else {\n        let origContent = fs.readFileSync(filename, 'utf8');\n        let result = compileContent(origContent);\n        content = result.content;\n\n        if (result.identical) {\n          writeFileLater(identicalKey, '');\n        } else {\n          writeFileLater(key, content);\n        }\n      }\n\n      return module._compile(content, filename, { compiledWithReify: true });\n    }\n  }\n\n  let immediateTimer = null;\n  let pendingWrites = Object.create(null);\n  function writeFileLater(key, content) {\n    pendingWrites[key] = content;\n    if (immediateTimer !== null) {\n      return;\n    }\n\n    immediateTimer = setImmediate(() => {\n      immediateTimer = null;\n      Object.keys(pendingWrites).forEach(key => {\n        try {\n          let targetPath = path.resolve(cachePath, key);\n          let tempPath = targetPath + '.tmp';\n          fs.writeFileSync(tempPath, pendingWrites[key]);\n          fs.renameSync(tempPath, targetPath);\n        } catch (err) {\n        }\n      });\n\n      pendingWrites = Object.create(null);\n    });\n  }\n}\n"],"mappings":"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","file":"tools/static-assets/server/runtime.js.map"}